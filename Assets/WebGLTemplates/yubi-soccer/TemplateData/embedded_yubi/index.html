<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Finger Soccer (Three.js + MediaPipe Hands)</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #000;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif;
      }
      #app {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        touch-action: none;
      }
      video#camera {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(1);
        z-index: 0;
        background: #000;
      }
      canvas#overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        pointer-events: none;
      }
      /* HUD simplified: only show FPS text, remove semi-transparent background */
      #ui {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 3;
        background: transparent !important; /* removed semi-transparent black box */
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important; /* keep layout minimal */
        margin: 0 !important;
        font-size: 13px;
        line-height: 1.2;
        backdrop-filter: none !important;
      }
      /* Ensure children don't show backgrounds or borders */
      #ui, #ui * {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      #controls {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 3;
        display: flex;
        gap: 6px;
        align-items: center;
      }
      button, label {
        font-size: 14px;
      }
      #startBtn {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 4;
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        background: #36c;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      }
      canvas#three {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="scene" style="position:absolute;inset:0;overflow:visible;transform-origin:0 0;transition: transform 120ms linear;">
        <video id="camera" playsinline muted></video>
        <canvas id="three"></canvas>
        <canvas id="overlay"></canvas>
      </div>
  <!-- internal preview removed per UX request -->
      <div id="ui">
        <div>FPS: <span id="fps">-</span></div>
      </div>
      <!-- カメラ選択ダイアログ -->
      <div id="deviceDialog" style="display:none; position:absolute; inset:0; background: rgba(0,0,0,0.6); z-index:5; align-items:center; justify-content:center;">
        <div id="devicePanel" style="background: rgba(16,16,16,0.9); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 12px; min-width: 280px; max-width: 92vw;">
          <div style="font-weight:700; margin-bottom: 8px;">カメラを選択</div>
          <select id="cameraSelect" style="width:100%; padding:6px; border-radius:6px; background:#111; color:#fff; border:1px solid rgba(255,255,255,0.2);"></select>
          <div style="display:flex; justify-content:flex-end; gap: 8px; margin-top:10px;">
            <button id="cancelDeviceBtn">キャンセル</button>
            <button id="useCameraBtn">使用する</button>
          </div>
        </div>
      </div>
      <button id="startBtn">開始</button>
    </div>

    <script type="module">
  import { setBall, updatePhysics, setRunBoost, kickImpulse } from './main.js';
  import { setupRenderer, resizeRendererToDisplaySize } from './renderer.js';
      import { HandTracker } from './hand.js';

      const video = document.getElementById('camera');
      const overlay = document.getElementById('overlay');
      const threeCanvas = document.getElementById('three');
      const startBtn = document.getElementById('startBtn');
  const fpsEl = document.getElementById('fps');
  // state/confidence removed from HUD
  const stateEl = null;
  const confEl = null;
  // Mirror is enabled by default now
  const MIRROR_DEFAULT = true;
  const deviceDialog = document.getElementById('deviceDialog');
  const cameraSelect = document.getElementById('cameraSelect');
  const useCameraBtn = document.getElementById('useCameraBtn');
  const cancelDeviceBtn = document.getElementById('cancelDeviceBtn');

  let three;
  let tracker;
  let lastState = 'NONE';

      function isSecureOrLocalhost() {
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        return location.protocol === 'https:' || isLocalhost;
      }

      async function listVideoDevicesEnsuringPermission() {
        let devices = await navigator.mediaDevices.enumerateDevices();
        let cams = devices.filter(d => d.kind === 'videoinput');
        const hasLabels = cams.some(d => d.label);
        if (!hasLabels) {
          try {
            const temp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            temp.getTracks().forEach(t => t.stop());
          } catch (_) { /* ignore */ }
          devices = await navigator.mediaDevices.enumerateDevices();
          cams = devices.filter(d => d.kind === 'videoinput');
        }
        return cams;
      }

      function showDeviceDialog(devices) {
        const preferred = localStorage.getItem('preferredCameraId');
        cameraSelect.innerHTML = '';
        for (const d of devices) {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `カメラ (${d.deviceId.slice(0,6)}…)`;
          if (preferred && preferred === d.deviceId) opt.selected = true;
          cameraSelect.appendChild(opt);
        }
        deviceDialog.style.display = 'flex';
      }

      async function startWithDeviceId(deviceId) {
        try {
          if (!isSecureOrLocalhost()) {
            throw new Error('このページは HTTPS で提供されていないため、カメラにアクセスできません。公開URL(HTTPS)で開いてください。');
          }
          const constraints = deviceId ? { video: { deviceId: { exact: deviceId } }, audio: false } : { video: { facingMode: 'user' }, audio: false };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          await video.play();
        } catch (err) {
          console.error(err);
          alert('カメラにアクセスできませんでした。\n' + (err && err.message ? err.message : 'Permission/HTTPS/デバイスの設定を確認してください。'));
          startBtn.disabled = false;
          return false;
        }

  // Three.js 初期化（描画とボール生成は renderer.js が担当）
  three = setupRenderer(threeCanvas);
  // renderer.setupRenderer は { scene, camera, renderer, clock, ball } を返す
  // physics 側へ ball を渡す
  setBall(three.ball);

        // Hand tracker 初期化
        tracker = new HandTracker({
          video,
          overlay,
          mirror: MIRROR_DEFAULT,
              onResult: ({ fps, state, confidence, charge }) => {
            fpsEl.textContent = fps.toFixed(0);
            // HUD only displays FPS; keep state/confidence for internal logic
            try { /* intended no-op for removed HUD fields */ } catch(e){}
            // charge display removed
            if (state === 'RUN') setRunBoost(confidence);
            if (state !== lastState && state === 'KICK') {
              kickImpulse(confidence);
            }
                // send state to parent (embedding page) so Unity can receive it
                try{
                  const msg = { type: 'state', state: state, confidence: confidence };
                  // If running standalone window.parent === window, but postMessage still works
                  window.parent.postMessage(msg, '*');
                }catch(e){ /* ignore */ }
            lastState = state;
          },
        });
        try {
          await tracker.init();
        } catch (e) {
          console.error(e);
          alert('MediaPipe (HandLandmarker) の初期化に失敗しました。\nネットワークや CDN へのアクセス状況を確認してください。');
          startBtn.disabled = false;
          startBtn.style.display = '';
          return false;
        }
        tracker.start();

        // Notify parent that the camera/tracker is started and ready.
        try {
          window.parent.postMessage({ type: 'camera', status: 'ready' }, '*');
        } catch (e) { /* ignore */ }

        // Apply default mirror transform (mirror enabled by default)
        video.style.transform = MIRROR_DEFAULT ? 'scaleX(-1)' : 'scaleX(1)';

        // レンダリングループ
        function renderLoop() {
          resizeRendererToDisplaySize(three.renderer, three.camera);
          updatePhysics(three.clock.getDelta());
          three.renderer.render(three.scene, three.camera);
          requestAnimationFrame(renderLoop);
        }
        requestAnimationFrame(renderLoop);

        startBtn.style.display = 'none';
        return true;
      }

      async function start() {
        try {
          const devices = await listVideoDevicesEnsuringPermission();
          if (!devices || devices.length === 0) {
            startBtn.disabled = true; // 実際に開始する時だけ無効化
            await startWithDeviceId(null);
            return;
          }
          if (devices.length === 1) {
            startBtn.disabled = true;
            localStorage.setItem('preferredCameraId', devices[0].deviceId);
            await startWithDeviceId(devices[0].deviceId);
            return;
          }
          // 複数あるので選択 UI を表示。ボタンは引き続き有効。
          showDeviceDialog(devices);
          startBtn.disabled = false;
        } catch (e) {
          console.error(e);
          alert('カメラデバイスの取得に失敗しました。通常の起動を試みます。');
          startBtn.disabled = true;
          await startWithDeviceId(null);
        }
      }

      useCameraBtn.addEventListener('click', async () => {
        const id = cameraSelect.value || null;
        deviceDialog.style.display = 'none';
        if (id) localStorage.setItem('preferredCameraId', id);
        startBtn.disabled = true;
        await startWithDeviceId(id);
      });

      cancelDeviceBtn.addEventListener('click', async () => {
        deviceDialog.style.display = 'none';
        startBtn.disabled = true;
        await startWithDeviceId(null);
      });

      // 背景クリックでキャンセル（誤って閉じた後でも開始ボタンを再度押せる）
      deviceDialog.addEventListener('click', (e) => {
        if (e.target === deviceDialog) {
          deviceDialog.style.display = 'none';
          startBtn.disabled = false;
        }
      });

      // start button is now controlled by parent page — listen for start_camera message
      startBtn.style.display = 'none';

      window.addEventListener('message', function(ev){
        var data = ev.data;
        try { if (typeof data === 'string') data = JSON.parse(data); } catch(e) { /* keep original */ }
        if (!data) return;
        if (data.type === 'start_camera'){
          var id = data.deviceId || null;
          // start with the requested device id
          startWithDeviceId(id);
        }
      }, false);
    </script>
  </body>
  </html>
